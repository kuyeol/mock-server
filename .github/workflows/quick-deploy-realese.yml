name: üöÄ Quick Deploy ‚Äî Quarkus Mock Server

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
#  Î°úÏª¨ÏóêÏÑú main Î∏åÎûúÏπòÏóê push ÌïòÎäî Ï¶âÏãú Ïã§Ìñâ
#  ÌÉúÍ∑∏/PR Î∂àÌïÑÏöî ‚Äî ÏΩîÎìú ÏàòÏ†ï ‚Üí push ‚Üí Î∞∞Ìè¨ ÏôÑÎ£å
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
on:
  push:
    branches: ["master"]

env:
  JAVA_VERSION: "21"
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  APP_NAME: mock-server                      # ‚Üê Ïª®ÌÖåÏù¥ÎÑà Ïù¥Î¶Ñ
  APP_PORT: 8282                             # ‚Üê Ïï± Ìè¨Ìä∏

jobs:
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  #  STEP 1 : Build  (fast-jar ÏÇ¨Ïö©)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  build-and-deploy:
    name: "Build ‚Üí Docker ‚Üí Deploy"
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write          # GHCR push Í∂åÌïú

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: temurin
          cache: maven          # ~/.m2 Ï∫êÏãú ‚Üí Ïû¨ÎπåÎìú ÏÜçÎèÑ Ìñ•ÏÉÅ

      # ‚îÄ‚îÄ ÎπåÎìú (ÌÖåÏä§Ìä∏ ÏÉùÎûµ ‚Äî ÏÜçÎèÑ Ïö∞ÏÑ†) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Maven Build (fast-jar, skip tests)
        run: |
          mvn -B package 
           

      # ‚îÄ‚îÄ JAR Î¶¥Î¶¨Ïä§ Ï∂îÍ∞Ä ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Find JAR file
        id: jar-file
        run: |
          JAR_FILE=$(find target -name "*.jar" -type f | head -1)
          if [ -z "$JAR_FILE" ]; then
            echo "‚ùå No JAR file found in target directory"
            exit 1
          fi
          echo "jar_path=$JAR_FILE" >> $GITHUB_OUTPUT
          echo "‚úÖ Found JAR: $JAR_FILE"

      - name: Create GitHub Release with JAR
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ steps.jar-file.outputs.jar_path }}
          body: |
            ## üöÄ Release
            - **Version**: ${{ github.ref_name }}
            - **Commit**: ${{ github.sha }}
            - **Date**: ${{ github.event.head_commit.timestamp }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ‚îÄ‚îÄ Docker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Push image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: src/main/docker/Dockerfile.jvm    # Quarkus Í∏∞Î≥∏ ÏÉùÏÑ± ÌååÏùº
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ‚îÄ‚îÄ SSH Î∞∞Ìè¨ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          # Ïª§Ïä§ÌÖÄ Ìè¨Ìä∏Î°ú Ìò∏Ïä§Ìä∏ ÌÇ§ Ïä§Ï∫î
          ssh-keyscan -p ${{ vars.DEPLOY_SSH_PORT }} ${{ vars.DEPLOY_HOST }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy to server
        run: |
            ssh -p ${{ vars.DEPLOY_SSH_PORT }} \
                ${{ vars.DEPLOY_USER }}@${{ vars.DEPLOY_HOST }} bash -s << 'EOF'
              set -e
              IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
            
              echo "${{ secrets.GITHUB_TOKEN }}" | \
                docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
              docker pull "$IMAGE"
              docker stop ${{ env.APP_NAME }} 2>/dev/null || true
              docker rm   ${{ env.APP_NAME }} 2>/dev/null || true
            
              docker run -d \
                --name ${{ env.APP_NAME }} \
                --restart unless-stopped \
                -p ${{ env.APP_PORT }}:8080 \
                "$IMAGE"
            
              docker image prune -f
              echo "‚úÖ Done ‚Äî $(docker ps --filter name=${{ env.APP_NAME }} --format '{{.Status}}')"
            EOF
      

      # ‚îÄ‚îÄ Ìó¨Ïä§Ï≤¥ÌÅ¨ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Health check
        run: |
          echo "‚è≥ Waiting for app..."
          for i in {1..6}; do
            STATUS=$(curl -sf -o /dev/null -w "%{http_code}" \
              http://${{ vars.DEPLOY_HOST }}:${{ env.APP_PORT }}/health/live 2>/dev/null || echo "000")
            [ "$STATUS" = "200" ] && echo "‚úÖ Live! (HTTP 200)" && exit 0
            echo "  [$i/6] HTTP $STATUS ‚Äî retry in 5s..."
            sleep 5
          done
          echo "‚ùå Health check failed"
          exit 1
