name: ğŸ”‘ SSH Key Setup (ìµœì´ˆ 1íšŒ ì‹¤í–‰)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  ìˆ˜ë™ìœ¼ë¡œë§Œ ì‹¤í–‰ (workflow_dispatch)
#  1. ed25519 í‚¤ìŒ ìƒì„±
#  2. ê³µê°œí‚¤ â†’ ì„œë²„ authorized_keys ë“±ë¡ (password 1íšŒ ì‚¬ìš©)
#  3. ê°œì¸í‚¤ â†’ GitHub Secret ìë™ ì €ì¥
#  ì´í›„ ë°°í¬ ì›Œí¬í”Œë¡œìš°ëŠ” í‚¤ ì¸ì¦ìœ¼ë¡œ ë™ì‘
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  workflow_dispatch:      # Actions íƒ­ì—ì„œ ìˆ˜ë™ ì‹¤í–‰

jobs:
  setup-ssh-key:
    name: "ğŸ”‘ Generate & Register SSH Key"
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      # â”€â”€ 1. í‚¤ ìƒì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Generate ed25519 key pair
        run: |
          mkdir -p ~/.ssh
          ssh-keygen -t ed25519 -C "github-actions@${{ github.repository }}" \
            -f ~/.ssh/deploy_key -N ""

          echo "âœ… Key pair generated"
          echo "Public key:"
          cat ~/.ssh/deploy_key.pub

      # â”€â”€ 2. ê³µê°œí‚¤ â†’ ì„œë²„ ë“±ë¡ (sshpass + password ì¸ì¦) â”€â”€
      - name: Install sshpass
        run: sudo apt-get install -y sshpass -q

      - name: Register public key to server
        env:
          _PORT: ${ env.DEPLOY_SSH_PORT }   # â† YAML ì¹˜í™˜ â†’ bash ë³€ìˆ˜ë¡œ ì „ë‹¬
          _HOST: ${ env.DEPLOY_HOST }
          _USER: ${ env.DEPLOY_USER }
        run: |
          PUB_KEY=$(cat ~/.ssh/deploy_key.pub)
          
          sshpass -p "$DEPLOY_PASSWORD" \
            ssh -o StrictHostKeyChecking=no \
                -p "$_PORT" \
                "$_USER@$_HOST" \
                "mkdir -p ~/.ssh && \
                 chmod 700 ~/.ssh && \
                 echo '$PUB_KEY' >> ~/.ssh/authorized_keys && \
                 chmod 600 ~/.ssh/authorized_keys && \
                 echo 'âœ… Public key registered'"

      # â”€â”€ 3. ì—°ê²° í…ŒìŠ¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Test key-based connection
        run: |
          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -p ${{ env.DEPLOY_SSH_PORT }} \
              ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} \
              "echo 'âœ… Key auth success'"

      # â”€â”€ 4. ê°œì¸í‚¤ â†’ GitHub Secret ìë™ ì €ì¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #  GitHub CLI (gh) ëŠ” Actions í™˜ê²½ì— ê¸°ë³¸ ë‚´ì¥ë¨
      - name: Save private key to GitHub Secret
        run: |
          PRIVATE_KEY=$(cat ~/.ssh/deploy_key)

          gh secret set SSH_PRIVATE_KEY \
            --body "$PRIVATE_KEY" \
            --repo ${{ github.repository }}

          echo "âœ… SSH_PRIVATE_KEY saved to GitHub Secrets"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}   # Secret ì“°ê¸° ê¶Œí•œ í•„ìš” (ì•„ë˜ ì£¼ì˜ì‚¬í•­ ì°¸ê³ )

      - name: Done
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… SSH í‚¤ ì„¤ì • ì™„ë£Œ"
          echo "   ì´ì œ quick-deploy.yml ì´ ìë™ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤"
          echo "   DEPLOY_PASSWORD Secretì€ ì‚­ì œí•´ë„ ë©ë‹ˆë‹¤"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
